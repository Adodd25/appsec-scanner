name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  security-events: write  # For SARIF upload

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python security tools
        run: |
          pip install bandit pyyaml semgrep

      - name: Install JavaScript security tools
        run: |
          npm install -g eslint eslint-plugin-security @typescript-eslint/parser

      - name: Install project dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f package.json ]; then npm install; fi

      - name: Run security scan (orchestrator)
        id: security_scan
        continue-on-error: true
        run: |
          python scripts/run_security_scan.py . --format json,html,sarif

      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('security-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-results.sarif

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            security-results.json
            security-report.html
            security-results.sarif
          retention-days: 30

      - name: Create PR comment with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üõ°Ô∏è Security Scan Results\n\n';

            try {
              if (fs.existsSync('security-results.json')) {
                const results = JSON.parse(fs.readFileSync('security-results.json', 'utf8'));

                // Summary counts
                const critical = results.critical_count || 0;
                const high = results.high_count || 0;
                const medium = results.medium_count || 0;
                const low = results.low_count || 0;
                const total = critical + high + medium + low;
                const secrets = results.secrets_found || 0;

                // Status indicator
                if (critical > 0 || high > 0) {
                  comment += '### ‚ùå Security Issues Found\n\n';
                } else if (medium > 0 || low > 0) {
                  comment += '### ‚ö†Ô∏è Minor Issues Found\n\n';
                } else {
                  comment += '### ‚úÖ No Security Issues Found\n\n';
                }

                // Summary table
                comment += '| Severity | Count |\n';
                comment += '|----------|-------|\n';
                comment += `| üî¥ Critical | ${critical} |\n`;
                comment += `| üü† High | ${high} |\n`;
                comment += `| üü° Medium | ${medium} |\n`;
                comment += `| üü¢ Low | ${low} |\n`;
                comment += `| **Total** | **${total}** |\n\n`;

                if (secrets > 0) {
                  comment += `‚ö†Ô∏è **${secrets} potential secrets detected!** Please review immediately.\n\n`;
                }

                // Scans performed
                const scans = results.scans_performed || [];
                if (scans.length > 0) {
                  comment += `**Scans:** ${scans.join(', ')}\n`;
                }
                comment += `**Duration:** ${results.scan_duration || 'N/A'}\n`;
                comment += `**Files scanned:** ${results.files_scanned || 0}\n\n`;

                // Top issues (if any)
                const allVulns = results.all_vulnerabilities || [];
                const criticalAndHigh = allVulns.filter(v =>
                  v.severity === 'critical' || v.severity === 'high'
                ).slice(0, 5);

                if (criticalAndHigh.length > 0) {
                  comment += '### Top Issues\n\n';
                  for (const vuln of criticalAndHigh) {
                    const icon = vuln.severity === 'critical' ? 'üî¥' : 'üü†';
                    comment += `- ${icon} **${vuln.title}** in \`${vuln.file}\`\n`;
                  }
                  comment += '\n';
                }

              } else {
                comment += '‚ö†Ô∏è No results file found. Check workflow logs.\n';
              }
            } catch (e) {
              comment += `‚ö†Ô∏è Error parsing results: ${e.message}\n`;
            }

            comment += '\nüìä See artifacts for detailed HTML report.\n';

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check for critical/high vulnerabilities
        if: always() && hashFiles('security-results.json') != ''
        run: |
          # Read vulnerability counts directly from results
          CRITICAL=$(python3 -c "import json; r=json.load(open('security-results.json')); print(r.get('critical_count', 0))")
          HIGH=$(python3 -c "import json; r=json.load(open('security-results.json')); print(r.get('high_count', 0))")

          echo "Critical: $CRITICAL, High: $HIGH"

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ùå Security scan found $CRITICAL critical and $HIGH high severity vulnerabilities"
            exit 1
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi
